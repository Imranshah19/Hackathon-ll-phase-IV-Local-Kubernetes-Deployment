# =============================================================================
# Docker Compose for Local Development
# =============================================================================
# Usage:
#   docker-compose up -d          # Start services
#   docker-compose down           # Stop services
#   docker-compose logs -f        # View logs
#   docker-compose build          # Rebuild images
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Backend Service - FastAPI
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: todo-backend
    ports:
      - "8000:8000"
    environment:
      # Database (Neon - external cloud, NOT in Docker)
      - DATABASE_URL=${NEON_DB_URL:-${DATABASE_URL}}
      - NEON_DB_URL=${NEON_DB_URL:-${DATABASE_URL}}
      # Authentication
      - AUTH_SECRET=${AUTH_SECRET:-${JWT_SECRET_KEY:-your-super-secret-auth-key-change-in-production}}
      - JWT_SECRET_KEY=${AUTH_SECRET:-${JWT_SECRET_KEY:-your-super-secret-auth-key-change-in-production}}
      # AI Configuration
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - AGENT_NAME=${AGENT_NAME:-todo-assistant}
      - BASE_URL=http://localhost:8000
      # Application
      - CORS_ORIGINS=http://localhost:3000,http://frontend:3000
      - ENVIRONMENT=development
      - LOG_LEVEL=INFO
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - todo-network

  # ---------------------------------------------------------------------------
  # Frontend Service - Next.js
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: todo-frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
      - NEXT_DOMAIN_KEY=${NEXT_DOMAIN_KEY:-}
      - AUTH_SECRET=${AUTH_SECRET:-${JWT_SECRET_KEY:-your-super-secret-auth-key-change-in-production}}
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    networks:
      - todo-network

# =============================================================================
# Networks
# =============================================================================
networks:
  todo-network:
    driver: bridge
